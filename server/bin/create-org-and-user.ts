#!/usr/bin/env node
/* eslint-disable no-console */
/**
 * Script to create a new organization and admin user
 * 
 * Usage:
 *   npm run create-org -- \
 *     --name "My Org" \
 *     --email "admin@example.com" \
 *     --website "https://example.com" \
 *     --firstName "John" \
 *     --lastName "Doe" \
 *     --password "securePassword123"
 */

import { uid } from 'uid';
import yargs from 'yargs';
import { hideBin } from 'yargs/helpers';

import getBottle from '../iocContainer/index.js';
import { hashPassword } from '../services/userManagementService/index.js';

const argv = await yargs(hideBin(process.argv))
  .options({
    name: {
      type: 'string',
      demandOption: true,
      description: 'Organization name',
    },
    email: {
      type: 'string',
      demandOption: true,
      description: 'Admin user email',
    },
    website: {
      type: 'string',
      demandOption: true,
      description: 'Organization website URL',
    },
    firstName: {
      type: 'string',
      demandOption: true,
      description: 'Admin user first name',
    },
    lastName: {
      type: 'string',
      demandOption: true,
      description: 'Admin user last name',
    },
    password: {
      type: 'string',
      demandOption: true,
      description: 'Admin user password',
    },
  })
  .help()
  .parse();

async function createOrgAndUser() {
  const bottle = await getBottle();
  const container = bottle.container;

  try {
    const orgId = uid();
    const userId = uid();

    // Create the organization
    const org = await container.Sequelize.Org.create({
      id: orgId,
      email: argv.email,
      name: argv.name,
      websiteUrl: argv.website,
    });

    // Create signing keys 
    await container.SigningKeyPairService.createAndStoreSigningKeys(orgId);

    // Create API key 
    const { apiKey: rawApiKey, record: apiKeyRecord } = 
      await container.ApiKeyService.createApiKey(
        orgId,
        'Main API Key',
        'Primary API key for organization',
        null,
      );

    // Update the org with the API key ID
    org.apiKeyId = apiKeyRecord.id;
    await org.save();

    // Initialize org settings
    await Promise.all([
      container.ModerationConfigService.createDefaultUserType(orgId),
      container.OrgCreationLogger.logOrgCreated(
        orgId,
        argv.name,
        argv.email,
        argv.website,
      ),
      container.UserManagementService.upsertOrgDefaultUserInterfaceSettings({
        orgId,
      }),
      container.OrgSettingsService.upsertOrgDefaultSettings({ orgId }),
      container.ManualReviewToolService.upsertDefaultSettings({ orgId }),
    ]);

    // Hash the password and create the admin user
    const hashedPassword = await hashPassword(argv.password);
    const user = await container.Sequelize.User.create({
      id: userId,
      email: argv.email,
      password: hashedPassword,
      firstName: argv.firstName,
      lastName: argv.lastName,
      role: 'ADMIN',
      approvedByAdmin: true,
      orgId,
      loginMethods: ['password'],
    });

    // Success! Print the details
    console.log('\nâœ… Organization and admin user created successfully!\n');
    console.log('â•'.repeat(60));
    console.log('Organization Details:');
    console.log('â•'.repeat(60));
    console.log(`Organization ID:   ${org.id}`);
    console.log(`Organization Name: ${org.name}`);
    console.log(`Organization Email: ${org.email}`);
    console.log(`Website URL:       ${org.websiteUrl}`);
    console.log('\n' + 'â•'.repeat(60));
    console.log('Admin User Details:');
    console.log('â•'.repeat(60));
    console.log(`User ID:           ${user.id}`);
    console.log(`Name:              ${user.firstName} ${user.lastName}`);
    console.log(`Email:             ${user.email}`);
    console.log(`Role:              ${user.role}`);
    console.log('\n' + 'â•'.repeat(60));
    console.log('ðŸ”‘ API KEY (STORE THIS SECURELY!)');
    console.log('â•'.repeat(60));
    console.log('\nNew API key generated successfully! Please copy and store it securely.\n');
    console.log(`API Key: ${rawApiKey}\n`);
    console.log('âš ï¸  This API key will not be shown again. Save it now!');
    console.log('â•'.repeat(60) + '\n');

    // Close all database connections
    await container.closeSharedResourcesForShutdown();
    process.exit(0);
  } catch (error: unknown) {
    console.error('\nâŒ Error creating organization and user:\n');
    console.error(error);
    
    // Try to close resources even on error
    try {
      await container.closeSharedResourcesForShutdown();
    } catch (shutdownError) {
      console.error('Error during shutdown:', shutdownError);
    }
    
    process.exit(1);
  }
}

createOrgAndUser().catch((error) => {
  console.error('Unhandled error:', error);
  process.exit(1);
});

